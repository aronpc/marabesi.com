---
layout: post
title: ZCPE 5.5 here we go – PHP Streams (Files/Http)
date: 2016-01-21 09:44:36.000000000 -02:00
type: post
published: true
status: publish
categories:
- php
- ZCPE
tags:
- file
- php
- streams
- zcpe
meta:
  _edit_last: '1'
  _login_radius_meta: '0'
  _yoast_wpseo_focuskw_text_input: streams
  _yoast_wpseo_focuskw: streams
  _yoast_wpseo_linkdex: '82'
  _yoast_wpseo_primary_category: ''
author:
  - Matheus Marabesi
---
<p>PHP has a great section about stream which is not used frequently by developers. Streams as the PHP documentation says :</p>
<p style="text-align: right;"><em> "In its simplest definition, a stream is a resource object which exhibits streamable behavior. That is, it can be read from or written to in a linear fashion"</em> (<a href="http://php.net/manual/en/intro.stream.php">php.net</a>)</p>
<p style="text-align: left;">In many cases streams are used  unconsciously when handling a file for example</p>

{% highlight php %}
<?php
print file_get_contents('http://www.marabesi.com/my_file.php');
{% endhighlight %}

<p>Look the code above where we are using the <strong>http://</strong> wrapper. Wrapper is what we use to handle a stream in PHP and there are a couple of wrappers in PHP <strong>file://</strong>, <strong>http://</strong>,<strong> ftp://</strong>,<strong> php://</strong>, <strong>zlib://</strong>, <strong>data://</strong>, <strong>glob://</strong>, <strong>phar://</strong>, <strong>ssh2://</strong>, <strong>rar://</strong>,<strong> ogg://</strong>, <strong>expect://</strong>. Each wrapper is used for a specific purpose in our example we used http because we are reading a file in a server, to access a file in a FTP server instead we might use <strong>ftp://</strong> or to find files in a given pattern we might use <strong>glob://</strong> and so on.</p>
<p>By default when no one is spefied PHP uses <strong>file://</strong></p>

{% highlight php %}
<?php
print file_get_contents('/foo/bar/file.txt');

print file_get_contents('file:///foo/bar/file.txt');
{% endhighlight %}

<p>Both reproduce the same result.</p>
<p>A interesting point is you can use PHP with any function that handles I/O</p>

{% highlight php %}
<?php
$file = fopen('file:///foo/bar/file.txt', 'r');

print fgets($file);
{% endhighlight %}

<p>Write to is very simple with streams as well</p>

{% highlight php %}
<?php
print file_put_contents('file:///foo/bar/file.txt', 'text data');
{% endhighlight %}

<h1>Adding context</h1>
<p>Some times when using <strong>http://</strong> wrapper we need to add some context such as headers in the request and to achieve that we need to use <a href="http://php.net/manual/en/function.stream-context-create.php" target="_blank"><strong>stream_context_create</strong></a>.</p>

{% highlight php %}
<?php
$http = [
  'http' => [
    'method' => 'GET',
    'header'=> 'Token: my_token'
  ]
];

$context = stream_context_create($http);
{% endhighlight %}

<p>Think about context as our scenario, something that we need to have to complete an action.</p>
<p>Once created our context we just need apply it to a stream</p>

{% highlight php %}
<?php
print file_get_contents('http://marabesi.com/file.txt', false, $context);
{% endhighlight %}

<p>In our example we are trying to read a file protected by a token. To read the file successfully we pass the token through the header in the request using our context, if we didn't pass the token we weren't able to read the file.</p>
<p>If you aren't convinced yet, lets move to the next example where we need to read a file over HTTP protocol within a proxy. How would you do that ?</p>

{% highlight php %}
<?php
$context = stream_context_create([
    'http' => [
        'timeout' => 10,
        'proxy' => 'tcp://my_proxy:3128',
        'request_fulluri' => true,
    ]
]);
{% endhighlight %}

<p>With streams we just created a context to apply in or <strong>file_get_contents</strong> function. But in our proxy settings we don't use any authentication, to do that we need to add  a header in our context</p>

{% highlight php %}
<?php
$auth = base64_encode('user:password');

$context = stream_context_create([
    'http' => [
        'timeout' => 10,
        'proxy' => 'tcp://my_proxy:3128',
        'header' => "Proxy-Authorization: Basic $auth",
        'request_fulluri' => true,
    ]
]);
{% endhighlight %}

<h1>Consider to use streams</h1>
<p>Streams are powerful and help us to build more robust PHP programs, in the past I used to use CURL to consume a simple web service, until I discover streams. Just look how good streams are:</p>
<ol>
<li>No extension needed (not true for all, some of them need eg: <strong>ssh2://</strong> and <strong>ogg://</strong>)</li>
<li>Easy to use, to write we just to have to use functions like <strong>file_put_contenst</strong> or <strong>fwrite</strong> (depends if you are using with resource or a real file)</li>
<li>Handle errors are much easier</li>
</ol>
<p>CURL is a amazing extension but we can do better natively with PHP, but it is up to you! Just check out the official documentation about streams <a href="http://php.net/manual/en/wrappers.php" target="_blank">here</a>.</p>
<h1>Edit: May 31, 2016</h1>
<p>You may wondering where you find all context options you can use with <strong>stream_create_context</strong> and this question is easily answered if you visit the PHP documentation in <a href="http://php.net/manual/en/context.php" target="_blank">http://php.net/manual/en/context.php</a>. There you can find all of them and use it as you wish.</p>
<p><iframe width="100%" height="485" style="border: 1px solid #CCC; border-width: 1px; margin-bottom: 5px; max-width: 100%;" src="//www.slideshare.net/slideshow/embed_code/key/16zvfeBdq17ErP" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" allowfullscreen="allowfullscreen"></iframe></p>

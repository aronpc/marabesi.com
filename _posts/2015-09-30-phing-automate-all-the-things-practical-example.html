---
layout: post
title: Phing ? Automate all the things ! - Practical example
date: 2015-09-30 01:46:25.000000000 -03:00
type: post
published: true
status: publish
categories:
- php
tags:
- automate
- composer
- dependency
- git
- github
- phing
- php
- phpunit
- target
- test
- unit
meta:
  _edit_last: '1'
  _login_radius_meta: '0'
  _yoast_wpseo_opengraph-image: http://marabesi.com/wp-content/uploads/2015/08/logo.gif
  _yoast_wpseo_twitter-image: http://marabesi.com/wp-content/uploads/2015/08/logo.gif
  _yoast_wpseo_focuskw: phing
  _yoast_wpseo_linkdex: '80'
  _yoast_wpseo_title: Phing ? Automate all the things ! - Practical example
author:
  - Matheus Marabesi




---
<p>If you want to know what is Phing, why should you use it and see some simple XML code please visit the part one of this post <a href="http://marabesi.com/php/phing-automate-all-the-things/" target="_blank">here</a>.</p>
<p>The main objective here is to demonstrate how Phing fits in our day as developers and how useful it is. Nothing better than a real example world to illustrate and clarify our minds.</p>
<h1>Starting the project</h1>
<p>Here I'm going to propose a workflow to ilustrate where Phing fits and how it can contribute to improve our productivity.</p>
<p>Usually when we start a new project that already exists we clone it, we run composer and we run PHPUnit to check if its all right.</p>
<p>It's kinda of boring when we have to do it manually and also we can make mistakes, for example I can forget to update my dependencies with composer and try to run unit tests, and get a error thrown. As a second advantage to use a build tool we can improve our productivity, while Phing run our tasks we can do other things. For instance let's see how our flow is going to work:</p>
<p><a href="http://marabesi.com/wp-content/uploads/2015/09/flow.png"><img class="alignnone size-full wp-image-571" src="{{ site.baseurl }}/assets/flow.png" alt="Phing flow" width="1600" height="1200" /></a></p>
<p>Describing it into step we have:</p>
<p>1) Cloning repository</p>
<p>2) Install/Update dependencies</p>
<p>3) Run unit tests</p>
<h1>Build.xml</h1>
<p>First of all we need to create targets to execute tasks. Let's start with the clone target.</p>

{% highlight xml %}
<?xml version="1.0" encoding="utf-8"?>
<project name="First Example" description="Clone, phpunit" default="clone">
    <property name="appdir" value="."/>
    <property name="repodir" value="./app"/>
    <property name="repo" value="https://github.com/marabesi/laravel-pagseguro.git" />

    <target name="clone">
        <echo msg="Cloning repository ${repo} please wait"/>
        <gitclone repository="${repo}" targetPath="${appdir}/app"/>
    </target>
</project>
{% endhighlight %}

<p>As you can see now we have a simple target that is going to clone the github repository and save it into <strong>app </strong>folder as specified in <strong>repodir</strong> property . The repository is defined in the <strong>repo</strong> property name.</p>
<p>Properties can be defined as a simple tag(static), or it can be defined through an properties file. To use it we must use ${my_property_name} sintax.</p>
<p>Defining property file</p>

{% highlight xml %}
<property file="project.properties"/>
{% endhighlight %}

<p>Defining static property</p>

{% highlight xml %}
<property name="local.property" value="hello"/>
{% endhighlight %}

<p>We can override properties using -D as argument followed by the property name in the command line.</p>

{% highlight sh %}
phing -f build-file.xml -Dlocal.property=testing
{% endhighlight %}

<p>As you can see we overrided our <strong>local.property</strong> with the value testing, when we run that instead of <strong>hello</strong> Phing will use <strong>testing</strong>.</p>
<p>The tag <strong>target</strong> indicates to us an project component, in other words to each component (or each task that we want to run) we have to create and target. Targets are the simplest container to be executed by Phing</p>
<p>Finally in <strong>project</strong> tag we have the attribute <strong>default</strong>, and as the name says, it is the default target Phing is going to run when we execute the build file.</p>
<p>So far we have just one target and we need to implement more two to update our dependencies and run our unit test.</p>
<h1>Optional Tasks</h1>
<h3>Dependencies</h3>
<p>Phing has various built-in tasks that we can use, known as optional tasks. Optional tasks are simple tasks that aren't related to the core of Phing and aren't tasks needed to build a project, for example, I use git in my project but you can use svn, so the git task is optional for you as svn is optional for me. Here we have the right fit to update our composer dependencies task.</p>

{% highlight xml %}
<target name="composerupdate" depends="clone">
      <composer composer="./composer.phar" command="install">
          <arg value="-d"/>
          <arg path="${repodir}" />
      </composer>
</target>
{% endhighlight %}

<p>The interesting part here is that we have a attribute in our target tag called depends, it means that Phing is going to run this target before run this(if no target specified in depends is found an error is thrown), in other words, we must have a cloned repository to update our dependencies, so it makes sense to depend on clone task.</p>
<p>For further information about optional tasks refer to <a href="https://www.phing.info/docs/stable/hlhtml/index.html#app.optionaltasks" target="_blank">Phing's official documentation</a>.</p>
<h3>Unit test</h3>
<p>In the same mood of  composer we have phpunit optinal task to run:</p>

{% highlight xml %}
<target name="phpunittests" depends="clone, composerupdate">
    <phpunit pharlocation="${appdir}/phpunit.phar"
             codecoverage="false" 
             bootstrap="${testdir}/bootstrap.php"
             haltonfailure="true"
             printsummary="true">
        <batchtest>
            <fileset dir="${testdir}">
                <include name="**/*Test.php"/>
            </fileset>
        </batchtest>
    </phpunit>
</target>
{% endhighlight %}

<p>And once again we take advantage of Phing with the optional task phpunit which provides a easy way to run unit tests using phpunt.</p>
<h1>Automate, automate, automate !</h1>
<p>With a fewer steps we automated our project, with Phing we can do much more and now is up to you keep automating. Play around with core tasks and optional tasks as well, Phing has a lot more to explore!</p>
<p>You can see full build file used in this post <a href="https://gist.github.com/marabesi/b3653f7dd290c6396b2d" target="_blank">here</a>.</p>

---
layout: post
title: WebSocket - HTML5
date: 2015-03-22 18:21:43.000000000 -03:00
type: post
published: true
status: publish
categories:
- php
tags:
- code pen
- html5
- http
- php
- rfc6455
- slideshare
- web sockets
meta:
  _edit_last: '1'
  _yoast_wpseo_focuskw: websocket
  _yoast_wpseo_title: WebScoket HTML5 and PHP
  _yoast_wpseo_linkdex: '74'
  _yoast_wpseo_metadesc: With the HTML5 age a lot of new features came to help developers
    to create amazing apps and amazing user experience, one of these features is called
    web socket which provides new powers under the HTTP protocol. Web socket resolves
    the lack of HTTP when we need updating our clients with real time data and also
    server events regardless of a request.
  _login_radius_meta: '0'
  _thumbnail_id: '373'
author:
  - Matheus Marabesi




---
<p>With the HTML5 age a lot of new features came to help developers to create amazing apps and amazing user experience, one of these features is called web socket which provides new powers under the HTTP protocol. Web socket resolves the lack of HTTP when we need updating our clients with real time data and also server events regardless of a request.</p>
<p><iframe width="100%" height="355" style="border: 1px solid #CCC; border-width: 1px; margin-bottom: 5px; max-width: 100%;" src="//www.slideshare.net/slideshow/embed_code/46061464" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" allowfullscreen="allowfullscreen"> </iframe></p>
<div style="margin-bottom: 5px;"><strong> <a title="Web Sockets - HTML5" href="//pt.slideshare.net/marabesi/web-sockets-html5" target="_blank">Web Sockets - HTML5</a> </strong> from <strong><a href="//www.slideshare.net/marabesi" target="_blank">Matheus Marabesi</a></strong></div>
<h1>The client side</h1>
<p>First of all let's have a look in the javascript code the easiest step to get web sockets working.</p>
<pre class="lang:js decode:true" title="WebSocket example without specifying the protocol">var mySocket = new WebSocket('ws://myserver');

mySocket.onopen = function() {};

mySocket.onclose = function() {};

mySocket.send = function() {};

mySocket.onerror = function() {};

mySocket.onmessage = function() {};</pre>
<p>With the snippet above we already have a code working but also we can specify which protocol we want to use through or connection.</p>
<pre class="lang:default mark:1 decode:true" title="WebSocket example with the protocol">var mySocket = new WebSocket('ws://myserver', ['myProtocol']);

mySocket.onopen = function() {};

mySocket.onclose = function() {};

mySocket.send = function() {};

mySocket.onerror = function() {};

mySocket.onmessage = function() {};</pre>
<h1>Handshake</h1>
<p>Now that we have the client already is time to concentrate in a key part of the process, the handshake. I would like to recommend if you don't know what is and why we must do that please see <a href="http://en.wikipedia.org/wiki/WebSocket#WebSocket_protocol_handshake">this wikipedia article</a> and <a href="https://www.websocket.org/aboutwebsocket.html">this from websocket.org</a>.</p>
<p>To perform a handshake we will need the client header and some hash stuff to return those combined to upgrade our header. The keyÂ header that we are looking for is the Sec-WebSocket-Key. So let's to our example!</p>
<pre class="lang:sh mark:6 decode:true" title="Headers example from websocket.org">GET ws://echo.websocket.org/?encoding=text HTTP/1.1
Origin: http://websocket.org
Cookie: __utma=99as
Connection: Upgrade
Host: echo.websocket.org
Sec-WebSocket-Key: uRovscZjNol/umbTt5uKmw==
Upgrade: websocket
Sec-WebSocket-Version: 13</pre>
<p>Our header value is uRovscZjNol/umbTt5uKmw== with that we will do the following steps on our server:</p>
<ol>
<li>Append to the uRovscZjNol/umbTt5uKmw== the value <em>258EAFA5-E914-47DA-95CA-C5AB0DC85B11</em></li>
<li>Create a SHA1 hash with the string</li>
<li>Apply the base64 enconding to the result of the SHA 1 encode</li>
</ol>
<p>The above steps translated to PHP code will be something like the example below</p>
<pre class="lang:php decode:true " title="Server side example using PHP of the handshake operation">$hds; //headers grabed from the client header

if(preg_match("/Sec-WebSocket-Key: (.*)\r\n/",$hds,$matchs)){ 
  $key = $matchs[1] . '258EAFA5-E914-47DA-95CA-C5AB0DC85B11'; 
  $key = base64_encode(sha1($key, true)); 
  $headers = "HTTP/1.1 101 Switching Protocols\r\n". 
             "Upgrade: websocket\r\n". 
             "Connection: Upgrade\r\n". 
             "Sec-WebSocket-Accept: " . $key . "\r\n\r\n";
}</pre>
<p>To deeper information go ahead and see the<a href="https://tools.ietf.org/html/rfc6455"> RFC 6455 documentation</a>.</p>
<h1>Wrapping everything up!</h1>
<p>As you saw on this post to create a websocket server from scratch is a tough task, roughly we have a couple of projects that do all the hard work for us. The most common in the PHP world is <a href="https://github.com/ratchetphp/Ratchet" target="_blank">Ratchet</a>, the documentation is awesome and the repository on github is updated frequently I do recommend Ratchet.</p>
